# Agentic Movement Test Guide

このドキュメントは、エージェント的な動き（Agentic Movement）の改善をテストするためのガイドです。

## 実装された変更点

### 1. 新しい `think` アクション
エージェントが明示的に思考を記録できる新しいアクションを追加しました：
- `phase: "planning"` - タスクの分解と計画
- `phase: "verification"` - 各フェーズ後の結果確認
- `phase: "reflection"` - 全体の振り返り

### 2. システムプロンプトの強化
エージェントに以下の動作フローを要求するようにプロンプトを更新：
1. **タスク分解**: 最初に `think(planning)` でタスクをフェーズに分解
2. **実行**: 計画したフェーズごとにツールを実行
3. **検証**: 各フェーズ後に `think(verification)` で結果を確認
4. **振り返り**: 完了前に `think(reflection)` で全体をレビュー

### 3. UI の改善
- チャットウィンドウで思考メッセージを別スタイルで表示（ベージュ背景）
- フェーズラベル（計画/検証/振り返り）を表示
- 計画、実行、検証の視覚的な区別

## テストシナリオ

### シナリオ 1: 簡単なブラウザタスク
**目標**: 「Safariを開いてGoogleを検索して」

**期待される動作**:
1. `think(planning)`: 
   - フェーズ1: Safariを起動
   - フェーズ2: Google検索ページを開く
   - フェーズ3: 完了確認
2. `osa`: Safariを起動
3. `think(verification)`: Safariが正しく起動したか確認
4. `type` + `press(enter)`: URLを入力
5. `think(verification)`: ページが正しく開いたか確認
6. `think(reflection)`: 全体の振り返り
7. `done`: タスク完了

### シナリオ 2: 複数ステップのタスク
**目標**: 「メモアプリを開いて『テスト』と入力して保存して」

**期待される動作**:
1. `think(planning)`: タスクを3フェーズに分解
   - フェーズ1: メモアプリを開く
   - フェーズ2: テキストを入力
   - フェーズ3: 保存を確認
2. 各フェーズの実行
3. 各フェーズ後の `think(verification)`
4. 最後に `think(reflection)` と `done`

### シナリオ 3: エラーリカバリーが必要なタスク
**目標**: 「存在しないアプリを開いてみて」

**期待される動作**:
1. `think(planning)`: 計画を立てる
2. 実行試行
3. `think(verification)`: エラーを検出
4. `think(planning)`: 代替案を考える
5. 最終的に適切に完了または報告

## 確認ポイント

### ✅ 計画段階
- [ ] タスク開始時に必ず `think(planning)` が呼ばれている
- [ ] 計画内容にタスクの分解が含まれている
- [ ] フェーズごとの目標が明確になっている

### ✅ 実行段階
- [ ] 計画したフェーズに従って順番に実行している
- [ ] 各ツール実行のタイミングが適切

### ✅ 検証段階
- [ ] 各フェーズ後に `think(verification)` が呼ばれている
- [ ] スクリーンショットの状態を確認している記述がある
- [ ] 問題があれば修正策を考えている

### ✅ 振り返り段階
- [ ] タスク完了前に `think(reflection)` が呼ばれている
- [ ] 全体の実行結果をレビューしている
- [ ] その後 `done` で完了している

### ✅ UI表示
- [ ] チャットウィンドウで思考メッセージが表示される
- [ ] 「思考中」ラベルとフェーズが表示される
- [ ] ベージュ背景で他のメッセージと区別できる

## 従来の動作との違い

### 従来
```
User: タスクを実行して
Agent: ← ツールを実行 →
Agent: 完了しました！
```

### 改善後
```
User: タスクを実行して
Agent: [計画] このタスクは3つのフェーズに分けます...
Agent: ← ツール実行 →
Agent: [検証] 期待通りの結果になっています...
Agent: ← 次のツール実行 →
Agent: [検証] 正しく動作しました...
Agent: [振り返り] すべてのフェーズが完了し、目標を達成しました
Agent: 完了しました！
```

## トラブルシューティング

### 問題: think アクションが呼ばれない
- システムプロンプトが正しく適用されているか確認
- LLMモデルが function calling をサポートしているか確認

### 問題: 思考メッセージがUIに表示されない
- backend controller が thinking イベントを emit しているか確認
- chat.tsx で thinking イベントをリスンしているか確認

### 問題: エージェントがまだ「実行してOK」で終わる
- システムプロンプトの「エージェント的な動作フロー」セクションが含まれているか確認
- モデルが指示に従っているか、より明示的な例を追加する必要があるかもしれません

## 次のステップ

1. 実際のタスクで動作を確認
2. 必要に応じてプロンプトを調整
3. より複雑なタスクでテスト
4. ユーザーフィードバックを収集
